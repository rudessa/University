# IoTRegistrationAPI
# Руководство по заданию: Работа с IoT регистрационным сервером и Telegram ботом

## Введение

Это руководство поможет настроить и использовать систему регистрации IoT устройств с уведомлениями через Telegram. Система состоит из:

1. **FastAPI сервера** - для регистрации и управления устройствами
2. **Telegram бота** - для уведомлений и взаимодействия с пользователями

## Необходимые ресурсы

Для работы с системой вам понадобятся:

1. **URL сервера**: http://77.239.120.215:8008/docs
2. **Telegram бот**: https://t.me/rudessa_bot 

## Шаги для выполнения задания

### 1. Подготовка локальных файлов

Скачайте файлы `main.py` и `notifier.py` из предоставленных артефактов для локального использования:

- `main.py` - содержит код FastAPI сервера
- `notifier.py` - содержит код для работы с Telegram ботом

### 2. Знакомство с API сервера

1. Откройте URL сервера в браузере: http://77.239.120.215:8008/docs
2. Изучите доступные эндпоинты через Swagger UI:
   - Регистрация устройств (`/register/`)
   - Управление устройствами (`/devices`, `/device/{device_id}`, etc.)
   - Управление пользователями (`/register_user`, `/identify_user/`, etc.)
   - Управление конфигурациями (`/configs/{device_id}`)

### 3. Взаимодействие с Telegram ботом

1. Откройте Telegram и найдите бота: https://t.me/rudessa_bot
2. Начните взаимодействие, отправив команду `/start`
3. Следуйте инструкциям для регистрации в системе
4. Используйте команду `/chatid` для получения вашего ID в Telegram
5. Изучите все доступные команды через `/help`

### 4. Регистрация устройства

1. Через Swagger UI на сервере выполните регистрацию устройства:
   - Откройте эндпоинт `/register/`
   - Нажмите "Try it out"
   - Заполните JSON с параметрами устройства:
     ```json
     {
       "longitude": 101.7121,
       "latitude": 56.2928,
       "height": 428,
       "city": "YourCity",
       "owner": "YourUsername",
       "measurement_type": "temperature",
       "sensor_model": "ESP32-DHT22",
       "mac_address": "DE:AD:BE:EF:12:34"
     }
     ```
   - Выполните запрос

2. После регистрации устройства вы должны получить уведомление в Telegram

### 5. Управление своими устройствами

1. Получите список своих устройств через запрос к `/devices?owner=YourUsername`
2. Для конкретного устройства можно:
   - Получить детали: `/device/{device_id}`
   - Обновить информацию: PUT `/device/{device_id}`
   - Получить MQTT топик: `/topics/{device_id}`
   - Настроить конфигурацию: POST `/configs/{device_id}`
   - Удалить устройство: DELETE `/device/{device_id}`

## Дополнительно: локальный запуск сервера

Если вы хотите запустить сервер локально:

1. Установите зависимости:
   ```
   pip install fastapi==0.115.8
   pip install pydantic==2.10.6
   pip install uvicorn[standard]==0.34.0
   pip install pyTelegramBotAPI==4.26.0
   ```

2. Настройте переменные окружения:
   ```
   export TELEGRAM_BOT_TOKEN="ваш_токен_бота"
   export TELEGRAM_CHAT_ID="ваш_chat_id"
   ```

3. Запустите сервер:
   ```
   uvicorn main:app --host 0.0.0.0 --port 8000
   ```

## Принцип работы системы

1. **Регистрация пользователей**:
   - Пользователи регистрируются через Telegram бота
   - В системе создается запись с chat_id и username

2. **Регистрация устройств**:
   - Устройства регистрируются через API
   - Идентификатор устройства генерируется на основе MAC-адреса
   - MQTT топик формируется как `{owner}/{city}/{measurement_type}/{device_id}`

3. **Уведомления**:
   - При регистрации устройства отправляются уведомления:
     - Системному администратору
     - Владельцу устройства (если он зарегистрирован в системе)

4. **Связь устройств с пользователями**:
   - Устройства можно привязать к пользователям через эндпоинт `/link_device`

Изучите код в файлах `main.py` и `notifier.py`, чтобы лучше понять, как реализована эта система.
